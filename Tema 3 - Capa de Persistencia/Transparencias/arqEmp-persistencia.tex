\documentclass[a4paper,slidestop,xcolor=pst,blue]{beamer}

\input{slidesHeader.tex}

\title[Capa de Persistencia]{Capa de Persistencia}

\author[P. S{\'a}nchez]{\alert{Pablo S{\'a}nchez}}

\institute[IIE]{
		   Dpto. Ingenier{\'i}a Inform{\'a}tica y Electr{\'o}nica \\
		   Universidad de Cantabria \\
		   Santander (Cantabria, Espa{\~n}a) \\
		   \texttt{p.sanchez@unican.es}
}

\date{}

\begin{document}

\begin{frame}[c]
	\titlepage
	\begin{columns}
		\column{0.50\linewidth}
			\centering
    		\includegraphics[width=.28\textwidth,keepaspectratio=true]{images/istr.eps}
		\column{0.50\linewidth}
			\centering
			\includegraphics[width=.25\textwidth,keepaspectratio=true]{images/uc.eps}
	\end{columns}
\end{frame}

\begin{frame}[c]
    \frametitle{\alert{Advertencia}}
    \begin{center}
        Todo el material contenido en este documento no constituye en modo alguno una obra de referencia o apuntes oficiales mediante el cual se puedan preparar las pruebas evaluables necesarias para superar la asignatura. \ \\
        \ \\
        Este documento contiene exclusivamente una serie de diapositivas cuyo objetivo es servir de complemento visual a las actividades realizadas en el aula para la transmisi{\'o}n del contenido sobre el cual versar{\'a}n las mencionadas pruebas evaluables.  \ \\
        \ \\
        Dicho de forma m{\'a}s clara, \alert{estas transparencias no son apuntes y su objetivo no es servir para que el alumno pueda preparar la asignatura.}
    \end{center}
\end{frame}

\section{Introducción}

\begin{frame}
    \frametitle{Capa de Persistencia}
    \only<1|handout:2>{
        \rput[lt](0,0){
            \includegraphics[width=\linewidth]{images/intro/enterpriseArchitectures00.eps}
        }
    }
    \only<2|handout:2>{
        \rput[lt](0,0){
            \includegraphics[width=\linewidth]{images/intro/enterpriseArchitectures01.eps}
        }
    }
\end{frame}

\begin{frame}[c]
	\frametitle{Responsabilidades de la Capa de Persistencia}
	\begin{enumerate}[<+->]
        \item Almacenar los datos de manera no volátil.
        \item Recuperar datos del almacén persistente.
        \item Asegurar la disponibilidad de los datos.
        \item Controlar la integridad de los datos.
        \item Asegurar un acceso eficiente a los datos.
	\end{enumerate}
\end{frame}

\begin{frame}[c]
    \frametitle{Objetivos del Tema}
    \begin{enumerate}[<+->]
         \item Comprender en profundidad cuáles son las responsabilidades de la capa de persistencia.
         \item Comprender el objetivo de los puentes objeto-(relacional).
         \item Comprender los principios de los patrones de persistencia estructurales.
         \item Comprender el funcionamiento de los patrones de acceso a datos.
         \item Ser capaz de utilizar \emph{JPA} para generar esquemas relacionales.
         \item Ser capaz de utilizar repositorios \emph{Spring} para acceder a datos.
    \end{enumerate}
\end{frame}

\begin{frame}[c]
    \frametitle{Bibliografía}
    \begin{thebibliography}{1}

        \bibitem[Fowler, 2002]{Fowler2002}
        Fowler, M. (2002).
        \newblock {\em {Patterns of Enterprise Application Architecture}}.
        \newblock Addison-Wesley.

        \bibitem[Esposito and Saltarello, 2014]{Esposito2014}
        Esposito, D. y Saltarello, A. (2014).
        \newblock {\em {Microsoft .NET - Architecting Applications for the
          Enterprise}}. 2ª Ed..
        \newblock Microsoft Press

        \bibitem[Bauer, 2015]{Bauer2015}
        Bauer, C., King. G. y Gregory G. (2015).
        \newblock {\em {Java Persistence with Hibernate}}. 2ª Ed.
        \newblock Manning

        %% Spring Data

    \end{thebibliography}
\end{frame}

%\begin{frame}[c]
%    \frametitle{Tecnologías de Persistencia}
%    \begin{description}[<+->]
%        \item[Relacional] Madurez, robustez y propiedades ACID.
%        \item[NoSQL] Escalabilidad y rendimiento sacrificando ACID.
%        \item[XML/JSON] Simplicidad.
%    \end{description}
%\end{frame}

\section{Puentes de Persistencia de Objetos}

\subsection{Impedancia Objeto - Persistencia}

\begin{frame}[c]
    \frametitle{Impedancia Objeto - (Relacional)}
    \begin{block}{Impedancia Objetual}
    La \emph{impedancia objetual} se refiere al desacoplamiento que puede existir en los conceptos del paradigma orientado a objetos y el paradigma utilizado por el almacén de persistencia.
    \end{block}
\end{frame}

\begin{frame}[c]
    \frametitle{Impedancia Objeto - Relacional}
    \begin{center}
        \includegraphics[width=\linewidth]{images/ooMismatch/ooMismatch00.eps}
    \end{center}
\end{frame}

\begin{frame}[c]
    \frametitle{Impedancia Objeto - Relacional}
    \begin{center}
        \includegraphics[width=0.8\linewidth]{images/ooMismatch/ooMismatch01.eps}
    \end{center}
\end{frame}

\begin{frame}[c]
    \frametitle{Impedancia OR: Claves Primarias}
    \begin{center}
        \includegraphics[width=\linewidth]{images/ooMismatch/ooMismatch09.eps}
    \end{center}
\end{frame}

%\begin{frame}[c]
%    \frametitle{Impedancia OR: Granularidad}
%    \begin{center}
%        \includegraphics[width=0.8\linewidth]{images/ooMismatch/ooMismatch08.eps}
%    \end{center}
%\end{frame}

\begin{frame}[c]
    \frametitle{Impedancia OR: Atributos Multivaluados}
    \begin{center}
        \includegraphics[width=\linewidth]{images/ooMismatch/ooMismatch02.eps}
    \end{center}
\end{frame}

\begin{frame}[c]
    \frametitle{Impedancia OR: Atributos Multivaluados}
    \begin{center}
        \includegraphics[width=0.8\linewidth]{images/ooMismatch/ooMismatch03.eps}
    \end{center}
\end{frame}

\begin{frame}[c]
    \frametitle{Impedancia OR: Herencia}
    \begin{center}
        \includegraphics[width=\linewidth]{images/ooMismatch/ooMismatch04.eps}
    \end{center}
\end{frame}

\begin{frame}[c]
    \frametitle{Impedancia OR: Navegabilidad Asociaciones}
    \begin{center}
        \includegraphics[width=\linewidth]{images/ooMismatch/ooMismatch05.eps}
    \end{center}
\end{frame}

\begin{frame}[c]
    \frametitle{Impedancia OR: Navegabilidad Asociaciones}
    \begin{center}
        \includegraphics[width=0.8\linewidth]{images/ooMismatch/ooMismatch06.eps}
    \end{center}
\end{frame}

\begin{frame}[c]
    \frametitle{Impedancia OR: Asociaciones Muchos a Muchos}
    \begin{center}
        \includegraphics[width=\linewidth]{images/ooMismatch/ooMismatch07.eps}
    \end{center}
\end{frame}

\begin{frame}[c]
    \frametitle{Impedancia OR: Asociaciones Muchos a Muchos}
    \begin{center}
        \includegraphics[width=0.8\linewidth]{images/ooMismatch/ooMismatch08.eps}
    \end{center}
\end{frame}

\subsection{Puentes Objeto-(Relacional)}

\begin{frame}
    \frametitle{Puentes de Persistencia de Objetos}
    \only<1|handout:3>{
        \rput[lt](0,0){
            \includegraphics[width=\linewidth]{images/ooMismatch/orm00.eps}
        }
    }
    \only<2|handout:3>{
        \rput[lt](0,0){
            \includegraphics[width=\linewidth]{images/ooMismatch/orm01.eps}
        }
    }
    \only<3|handout:3>{
        \rput[lt](0,0){
            \includegraphics[width=\linewidth]{images/ooMismatch/orm02.eps}
        }
    }
    \only<4|handout:3>{
        \rput[lt](0,0){
            \includegraphics[width=\linewidth]{images/ooMismatch/orm03.eps}
        }
    }
\end{frame}

\section{Patrones Estructurales}

\subsection{Conceptos Básicos}

\subsubsection{Class to Table}

\begin{frame}[c]
    \frametitle{Class to Table}
    \begin{block}{Problema}
        \begin{enumerate}
            \item ¿Cómo transformo una clase a relacional?
        \end{enumerate}
    \end{block}
    \uncover<2->{
        \begin{block}{Solución}
            Si la clase es una \emph{entidad}, no está afectada por herencia, y no tiene atributos compuestos:
            \begin{enumerate}
                \item<3-> Crear una tabla con el mismo nombre de la clase.
                \item<4-> Crear una columna en dicha tabla por cada atributo de la clase.
                \item<5-> Asignar como tipo de la columna el tipo que corresponda a cada atributo.
            \end{enumerate}
        \end{block}
    }
\end{frame}

\begin{frame}
    \frametitle{Class to Table}
    \rput[lt](3.5,0){
            \includegraphics[width=0.50\linewidth]{images/structure/class2Table00.eps}
    }
    \only<2->{
        \rput[lt](3,-4){
                \includegraphics[width=0.50\linewidth]{images/structure/class2Table01.eps}
        }
    }
\end{frame}


\subsubsection{Identity Field}

\begin{frame}[c]
    \frametitle{Identity Field}
    \begin{block}{Problema}
        \begin{enumerate}
            \item ¿Cómo obtengo una clave primaria para cada objeto que necesito guardar en la base de datos relacional?
        \end{enumerate}
    \end{block}
    \uncover<2->{
        \begin{block}{Solución}
            \begin{enumerate}
                \item<2-> Utilizar un atributo (o atributos) existente como clave primaria para los objetos de dicha clase.
                \item<3-> Añadir un nuevo atributo que ejerza de clave primaria.
            \end{enumerate}
        \end{block}
    }
\end{frame}

\subsection{Transformación de Asociaciones}

\subsubsection{Embedded Value}

\subsubsection{Foreign Key Mapping}

\subsubsection{Association Table Mapping}

\subsection{Transformación de Herencias}

\subsubsection{Single Table Inheritance}

\begin{frame}[c]
    \frametitle{Single Table Inheritance}
    \begin{block}{Problema}
        \begin{enumerate}
            \item ¿Cómo implemento una jerarquía de herencia en un esquema relacional?
        \end{enumerate}
    \end{block}
    \uncover<2->{
        \begin{block}{Solución}
            \begin{enumerate}
                \item<2-> Comprimir la jerarquía en una sola clase, incorporando los atributos de las clases hijas a la raíz de la jerarquía.
                \item<3-> Añadir un atributo que indique de qué tipo concreto es cada instancia de la nueva clase resultante.
                \item<3-> Transforma la clase resultante a una tabla.
                \item<4-> Cuando un objeto de dicha jerarquía se almacena dentro de una tabla, los atributos que no correspondan a dicha instance simplemente se ignoran.
            \end{enumerate}
        \end{block}
    }
\end{frame}

\begin{frame}
    \frametitle{Single Table Inheritance}
    \rput[lt](3.5,0){
            \includegraphics[width=0.50\linewidth]{images/structure/singleTable00.eps}
    }
%    \only<2->{
%%        \rput[lt](3,-4){
%%                \includegraphics[width=0.50\linewidth]{images/structure/class2Table01.eps}
%%        }
%    }
\end{frame}

\subsubsection{Concrete Table Inheritance}

\subsubsection{Class Table Inheritance}

\subsubsection{Comparación de Transformación de Herencias}

\section{Patrones de Acceso a Datos}

\subsubsection{Data Access Object}

\subsubsection{Metadata Mapping}

\subsection{Patrones Auxiliares}

\subsubsection{Lazy Load}

\subsubsection{Identity Map}

\subsubsection{Query Object}

%\subsubsection{Unit of Work}
%
%\begin{frame}[c]
%    \frametitle{Unit of Work - Problema}
%    \begin{block}{Problema}
%        Dentro de una misma \emph{transacción de negocio} se podrían realizar múltiples cambios en diversos objetos de dominio, por lo que estos cambios han de realizarse de manera transaccional.
%        \begin{emumerate}
%            \item<2-> Para poder gestionar la transacción, necesito saber con exactitud que ha cambiado, lo cual puede ser no trivial en ciertos casos (e.g., observadores).
%            \item<3-> Si cada cambio se refleja automáticamente en el sistema de persistencia, se generan demasiadas comunicaciones de pequeño tamaño, alguna de las cuales podría ser incluso no necesaria .
%            \item<4-> Necesito saber qué datos se han utilizado a lo largo de la transacción para poder determinar si dicha transacción es válida o no antes de confirmarla y cerrarla.
%        \end{emumerate}
%    \end{block}
%    %% Añadir una transparencia con un bloque de código.
%\end{frame}

%\begin{frame}[c]
%    \frametitle{Unit of Work - Solución}
%    \begin{block}{Solución}
%        \begin{enumerate}
%           \item<1-> Crear una clase denominada \emph{Unit of Work} donde se vayan registrando todos los cambios que se realizan dentro de una \emph{transacción de negocio}.
%           \item<2-> Hacer que los objetos de dominio cuando cambien se registren dentro de la unidad de trabajo como cambiados.
%           \item<3-> Hacer que los objetos de dominio utilizados dentro de una transacción se almacenen dentro de la unidad de trabajo como leídos.
%           \item<4-> Añadir métodos a la unidad de trabajo para validar y cerrar la transacción.
%       \end{enumerate}
%    \end{block}
%
%    %% Añadir imagen UML de Unit of Work.
%\end{frame}

%\section{Patrones de Control de la Concurrencia}
%
%\subsection{Pessimistic Lock}
%
%\begin{frame}[c]
%    \frametitle{Pessimistic Lock - Problema}
%    \begin{block}{Problema}
%        Cómo evitar conflictos cuando se accede a un mismo conjunto de datos de manera concurrente.
%    \end{block}
%    %% Poner escenario ilustrando el problema
%\end{frame}
%
%\begin{frame}[c]
%    \frametitle{Pessimistic Lock - Solución}
%    \begin{block}{Solución}
%        \begin{enumerate}
%           Cada transacción bloquea los datos que necesita de manera que otras transacciones no puedan hacer uso de ellos.
%       \end{enumerate}
%    \end{block}
%\end{frame}
%
%\subsection{Optimistic Lock}
%
%\begin{frame}[c]
%    \frametitle{Optimistic Lock - Problema}
%    \begin{block}{Problema}
%        Cómo evitar conflictos cuando se accede a un mismo conjunto de datos de manera concurrente.
%    \end{block}
%    %% Poner escenario ilustrando el problema
%\end{frame}
%
%\begin{frame}[c]
%    \frametitle{Optimistic - Solución}
%    \begin{block}{Solución}
%        \begin{enumerate}
%           Permito lecturas concurrentes y antes de guardar los datos compruebo que los datos que he utilizado no han sido modificados por otra transacción. Si hubiesen sido modificados, aborto la transacción.
%       \end{enumerate}
%    \end{block}
%\end{frame}

\section{Java Persistence API y Spring Data}

\subsection{Esquema}

\subsection{Anotaciones JPA}

\begin{frame}[c]
    \frametitle{Anotaciones JPA}
    \begin{description}
        \item[@Entity]
        \item[@Embeddable]
        \item[@Id]
        \item[@GeneratedValue]
        \item[@Embedded]
        \item[@OneToOne]
        \item[@OneToMany]
        \item[@ManyToOne]
        \item[@ManyToMany]
        \item[mappeddBy]
        \item[@Inheritance(strategy=)]
    \end{description}
\end{frame}

\begin{frame}[c]
    \frametitle{Ciclo de Vida de una Entidad JPA}
    %% Diagrama de las actividades
    %% Se puede llegar a través de agregados, es decir, como referencia desde
    %% una entidad, normalmente un agregado
\end{frame}

\begin{frame}[c]
    \frametitle{Ciclo de Vida de una Entidad JPA}
    %% Detecta transacciones de usuario.
\end{frame}

% \subsection{Validación en JPA}

\subsection{Clases JPA}

\subsection{Spring Data}

\section{Sumario y Conclusiones}

\end{document}
